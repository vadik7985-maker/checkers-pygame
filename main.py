"""
Основной модуль запуска игры "Шашки".

Этот модуль является точкой входа в приложение. Он выполняет:
1. Настройку окружения и загрузку переменных из .env файла
2. Подключение к базе данных PostgreSQL
3. Инициализацию графического интерфейса PyGame
4. Запуск основного игрового цикла
5. Обработку ошибок и корректное завершение работы

Зависимости:
    - pygame: графическая библиотека
    - python-dotenv: загрузка переменных окружения
    - psycopg2: драйвер PostgreSQL (через src.database)
"""

import sys
import os
import pygame
from dotenv import load_dotenv

# добавляем диагностику - вывод отладочной информации для понимания где запускается программа
print("=" * 50)
# выводим текущую рабочую директорию (откуда запущен скрипт)
print(f"текущая директория: {os.getcwd()}")
# выводим полный путь к файлу main.py (где физически находится файл)
print(f"путь к main.py: {__file__}")
print("=" * 50)

# проверяем наличие .env файлов, которые содержат настройки подключения к базе данных
env_paths = [
    '.env',  # текущая директория (откуда запущен скрипт)
    os.path.join(os.path.dirname(__file__), '.env'),  # рядом с main.py (в той же папке)
]
# перебираем все возможные пути к .env файлу
for env_path in env_paths:
    # проверяем, существует ли файл по данному пути
    if os.path.exists(env_path):
        # если нашли файл, выводим информацию об этом
        print(f"найден .env файл: {env_path}")
        # загружаем переменные окружения из найденного файла
        load_dotenv(env_path)
        break
else:
    # этот блок выполняется только если цикл завершился без break
    print("внимание: .env файл не найден!")
    # программа продолжит работу, но возможно будут проблемы с подключением к БД

# проверяем, что все необходимые переменные окружения загружены
print("\nпроверка переменных окружения:")
# список обязательных переменных для подключения к postgresql
env_vars = ['DB_HOST', 'DB_PORT', 'DB_NAME', 'DB_USER', 'DB_PASSWORD']

# перебираем все обязательные переменные
for var in env_vars:
    # пытаемся получить значение переменной окружения
    value = os.getenv(var)
    # выводим результат: если значение есть - показываем его, иначе "не найдена"
    print(f"  {var}: {value if value else 'НЕ НАЙДЕНА'}")

print("=" * 50)


from src.graphics import CheckersGUI
from src.database import db_manager


def main():
    """Основная функция запуска игры.

    Инициализирует все компоненты приложения и запускает игровой цикл.
    Обеспечивает корректную обработку ошибок и освобождение ресурсов.

    Raises:
        Exception: Любая ошибка при запуске игры логируется и выводится

    Примечание:
        Использует конструкцию try-except-finally для гарантированного
        закрытия соединений с БД и PyGame.
    """
    try:
        # Пытаемся подключиться к базе данных
        try:
            db_manager.connect()
        except Exception as db_error:
            print(f"Не удалось подключиться к базе данных: {db_error}")
            print("Игра будет работать без сохранения статистики")

        pygame.init()
        pygame.font.init()
        gui = CheckersGUI()
        gui.run()
    except Exception as e:
        print(f"Ошибка при запуске игры: {e}")
        import traceback
        traceback.print_exc()
    finally:
        db_manager.close()
        pygame.quit()
        sys.exit()


if __name__ == "__main__":
    """Точка входа при запуске файла напрямую.

    Вызывает функцию main() и завершает программу с кодом возврата.
    """
    main()